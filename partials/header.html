/* EDX Partials Loader â€” GitHub Pages project-site safe (CSP-safe, auto-boot)
 *
 * Key behavior (fix for your issue):
 * - When your repo is served as: https://abupathan.github.io/EDXLake/
 *   any partial links like "../../support/docs.html" (in header.html) :contentReference[oaicite:0]{index=0}
 *   can incorrectly resolve to: https://abupathan.github.io/support/docs.html
 *   (missing "/EDXLake").
 *
 * This loader:
 * 1) Computes repo base ("/EDXLake") correctly.
 * 2) Injects partials from <base>/partials/...
 * 3) Rewrites internal links in injected partials so they always include <base>.
 *
 * Partials expected:
 *   <base>/partials/header.html
 *   <base>/partials/footer.html
 *   <base>/partials/sidebar-<role>.html
 */

(function () {
  "use strict";

  const $  = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

  /* ---------- helpers ---------- */
  function stripTrailingSlash(p) {
    return (p || "").replace(/\/+$/, "");
  }

  function ensureLeadingSlash(p) {
    const s = String(p || "");
    return s.startsWith("/") ? s : `/${s}`;
  }

  function join(base, rel) {
    const b = stripTrailingSlash(base || "");
    const r = String(rel || "").replace(/^\/+/, "");
    if (!b) return `/${r}`.replace(/^\/+/, "/");
    return `${b}/${r}`;
  }

  function withBase(base, appPath) {
    const p = String(appPath || "");
    if (/^https?:\/\//i.test(p)) return p;
    const normalized = ensureLeadingSlash(p);
    const b = stripTrailingSlash(base || "");
    return b ? `${b}${normalized}` : normalized;
  }

  /* ---------- compute base (supports GitHub Pages project sites) ---------- */
  function computeBaseFromPathname() {
    const p = location.pathname || "/";

    // Prefer: strip before "/pages/" because most app pages are under /pages/*
    const idxPages = p.indexOf("/pages/");
    if (idxPages !== -1) return stripTrailingSlash(p.slice(0, idxPages));

    // Also support: /auth/*
    const idxAuth = p.indexOf("/auth/");
    if (idxAuth !== -1) return stripTrailingSlash(p.slice(0, idxAuth));

    // Home page of a project site: "/EDXLake/" or "/EDXLake/index.html"
    const parts = p.split("/").filter(Boolean);
    if (parts.length >= 1) return `/${parts[0]}`;

    // User/org pages root: "/"
    return "";
  }

  const PARTIALS = {
    header: (base)        => join(base, "partials/header.html"),
    footer: (base)        => join(base, "partials/footer.html"),
    sidebar: (base, role) => join(base, `partials/sidebar-${role || "consumer"}.html`)
  };

  const PROTECTED_ROLE_SEGMENTS = [
    "/pages/consumer/",
    "/pages/steward/",
    "/pages/engineer/",
    "/pages/admin/"
  ];

  /* ---------- fetch + inject ---------- */
  function sanitizeNoScripts(html) {
    return String(html).replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi, "");
  }

  async function fetchText(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
    return sanitizeNoScripts(await res.text());
  }

  async function inject(sel, url) {
    const host = $(sel);
    if (!host) return null;

    try {
      host.innerHTML = await fetchText(url);
      return host;
    } catch (e) {
      console.warn("[EDX] Failed to load partial", { sel, url, e });
      host.innerHTML = `<div class="alert alert-warning small mb-0">Failed to load: ${url}</div>`;
      return null;
    }
  }

  /* ---------- session / auth ---------- */
  function readUser() {
    try {
      return JSON.parse(localStorage.getItem("edx:user") || "null") || null;
    } catch {
      return null;
    }
  }

  function isProtectedPath(pathname) {
    const p = pathname || "";
    return PROTECTED_ROLE_SEGMENTS.some((seg) => p.includes(seg));
  }

  function redirectToSignin(base) {
    const candidates = [
      withBase(base, "/auth/signin.html"),
      withBase(base, "/signin.html"),
      // relative fallbacks
      "signin.html",
      "../signin.html",
      "../../signin.html",
      "../auth/signin.html",
      "../../auth/signin.html"
    ];

    for (const c of candidates) {
      try {
        location.assign(c);
        return;
      } catch {}
    }
  }

  function requireAuthIfProtected(base) {
    const path = location.pathname || "";
    if (!isProtectedPath(path)) return;

    const u = readUser();
    const validRole = !!(u && typeof u.role === "string" && u.role.trim().length > 0);
    if (!validRole) redirectToSignin(base);
  }

  /* ---------- critical fix: rewrite internal links in injected partials ---------- */
  function rewriteInjectedLinks(base, scope) {
    if (!scope) return;
    const b = stripTrailingSlash(base || "");
    if (!b) return; // if served at root, no rewrite needed

    const origin = location.origin;

    $$("a[href]", scope).forEach((a) => {
      const raw = (a.getAttribute("href") || "").trim();
      if (!raw) return;

      // skip anchors / protocols / special schemes
      if (raw.startsWith("#")) return;
      if (/^(https?:)?\/\//i.test(raw)) return;     // absolute URL or protocol-relative
      if (/^(mailto:|tel:|javascript:)/i.test(raw)) return;

      // Resolve the link as the browser would from the current page
      // (this is what currently produces "/support/docs.html" for your header links).
      let u;
      try {
        u = new URL(raw, location.href);
      } catch {
        return;
      }

      const path = u.pathname || "/";
      const search = u.search || "";
      const hash = u.hash || "";

      // If it's already under base, keep it.
      if (path === b || path.startsWith(b + "/")) return;

      // Only rewrite same-origin absolute paths.
      // Example:
      //   resolved path "/support/docs.html"  -> "/EDXLake/support/docs.html"
      //   resolved path "/index.html"         -> "/EDXLake/index.html"
      if (path.startsWith("/")) {
        const newPath = b + path; // safe because base has leading "/" and path has leading "/"
        a.setAttribute("href", newPath + search + hash);
      }
    });
  }

  /* ---------- header hydration ---------- */
  function applyUserToHeader(scope = document) {
    const u = readUser();
    const name  = u?.name || (u?.email ? u.email.split("@")[0] : "user");
    const email = u?.email || "user@example.edu";
    const role  = (u?.role || "consumer").replace(/_/g, " ");

    $("#currentUserName", scope)?.replaceChildren(document.createTextNode(name));
    $("#currentUserRole", scope)?.replaceChildren(document.createTextNode(role));
    $("#menuUserName", scope)?.replaceChildren(document.createTextNode(name));
    $("#menuUserEmail", scope)?.replaceChildren(document.createTextNode(email));
  }

  /* ---------- dark mode ---------- */
  const THEME_KEY = "edx:theme";

  function getTheme() {
    const t = localStorage.getItem(THEME_KEY);
    if (t === "light" || t === "dark") return t;
    return document.documentElement.getAttribute("data-bs-theme") || "light";
  }

  function setTheme(t) {
    document.documentElement.setAttribute("data-bs-theme", t);
    localStorage.setItem(THEME_KEY, t);
  }

  function wireThemeToggle(scope = document) {
    const btn = $("#themeToggle", scope);
    if (!btn) return;

    btn.classList.remove("d-none");
    const icon = btn.querySelector("i");

    const refreshIcon = () => {
      if (!icon) return;
      const cur = getTheme();
      icon.classList.remove("bi-moon", "bi-sun");
      icon.classList.add(cur === "dark" ? "bi-sun" : "bi-moon");
      btn.setAttribute("aria-label", cur === "dark" ? "Switch to light mode" : "Switch to dark mode");
    };

    setTheme(getTheme());
    refreshIcon();

    btn.addEventListener("click", () => {
      const next = getTheme() === "dark" ? "light" : "dark";
      setTheme(next);
      refreshIcon();
    });
  }

  /* ---------- global search (header) ---------- */
  function wireGlobalSearch(base, scope = document) {
    const form  = $("#globalSearchForm", scope);
    const input = $("#globalSearchInput", scope);
    if (!form || !input) return;

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const q = input.value.trim();
      const target = q.length
        ? withBase(base, `/pages/consumer/catalog-browse.html?q=${encodeURIComponent(q)}`)
        : withBase(base, "/pages/consumer/catalog-browse.html");
      location.href = target;
    });
  }

  /* ---------- sidebar helpers ---------- */
  function markActiveLinks(scope = document) {
    const here = stripTrailingSlash(location.pathname || "/") || "/";
    $$("a[href]", scope).forEach((a) => {
      const href = a.getAttribute("href") || "";
      try {
        const target = stripTrailingSlash(new URL(href, location.origin).pathname) || "/";
        if (target === here) a.classList.add("active");
      } catch {}
    });
  }

  function syncRoleInStorage(role) {
    if (!role) return;
    const u = readUser() || {};
    if (u.role !== role) {
      try {
        localStorage.setItem("edx:user", JSON.stringify({ ...u, role }));
      } catch {}
    }
  }

  /* ---------- public API ---------- */
  async function loadPartials({ base, role } = {}) {
    const resolvedBase = base ?? computeBaseFromPathname();

    // auth check (base-aware redirect)
    requireAuthIfProtected(resolvedBase);

    const pageRoleAttr = document.body?.getAttribute("data-edx-sidebar");
    const resolvedRole = (role || pageRoleAttr || readUser()?.role || "consumer").toLowerCase();

    // header
    const headerHost = await inject("#app-header", PARTIALS.header(resolvedBase));
    if (headerHost) rewriteInjectedLinks(resolvedBase, headerHost);
    applyUserToHeader(document);
    wireThemeToggle(document);
    wireGlobalSearch(resolvedBase, document);

    // sidebar
    syncRoleInStorage(resolvedRole);
    const sidebarHost = await inject("#app-sidebar", PARTIALS.sidebar(resolvedBase, resolvedRole));
    if (sidebarHost) {
      rewriteInjectedLinks(resolvedBase, sidebarHost);
      markActiveLinks(sidebarHost);
    }

    // footer
    const footerHost = await inject("#app-footer", PARTIALS.footer(resolvedBase));
    if (footerHost) rewriteInjectedLinks(resolvedBase, footerHost);

    // live updates (multi-tab)
    window.addEventListener("storage", (e) => {
      if (e.key === "edx:user") applyUserToHeader();
      if (e.key === THEME_KEY) setTheme(getTheme());
    });
  }

  // expose + AUTO-BOOT
  window.EDXPartials = { loadPartials, applyUserToHeader };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => loadPartials().catch(console.error), { once: true });
  } else {
    loadPartials().catch(console.error);
  }
})();
